<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Quad(ric) Function - RAY-X Wiki</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded "><a href="../Developer/Developer.html"><strong aria-hidden="true">1.</strong> Developer Area</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Developer/How-to-Build.html"><strong aria-hidden="true">1.1.</strong> How to Build</a></li><li class="chapter-item expanded "><a href="../Developer/Style-Guide-for-Programming-in-Ray.html"><strong aria-hidden="true">1.2.</strong> Style Guide for Programming in RAY</a></li><li class="chapter-item expanded "><a href="../Developer/Testing.html"><strong aria-hidden="true">1.3.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../Developer/How-to-use-our-formatter.html"><strong aria-hidden="true">1.4.</strong> How to use our Formatter</a></li><li class="chapter-item expanded "><a href="../Developer/How-to-use-Doxygen.html"><strong aria-hidden="true">1.5.</strong> How to use Doxygen</a></li><li class="chapter-item expanded "><a href="../Developer/PRNGs-on-the-GPU.html"><strong aria-hidden="true">1.6.</strong> PRNGs on the GPU</a></li><li class="chapter-item expanded "><a href="../Developer/Transformation-between-coordinate-systems.html"><strong aria-hidden="true">1.7.</strong> Transformation between coordinate systems</a></li><li class="chapter-item expanded "><a href="../Developer/Quad(ric)-function.html" class="active"><strong aria-hidden="true">1.8.</strong> Quad(ric) Function</a></li><li class="chapter-item expanded "><a href="../Developer/Approximation-of-ray-object-intersection-in-the-case-of-quadric-surfaces.html"><strong aria-hidden="true">1.9.</strong> Approximation of ray object intersection in the case of quadric surfaces</a></li><li class="chapter-item expanded "><a href="../Developer/Efficiency.html"><strong aria-hidden="true">1.10.</strong> Efficiency calculations</a></li><li class="chapter-item expanded "><a href="../Developer/Plane-Mirror.html"><strong aria-hidden="true">1.11.</strong> Plane Mirror</a></li><li class="chapter-item expanded "><a href="../Developer/RZP.html"><strong aria-hidden="true">1.12.</strong> Reflection Zone Plate (RZP)</a></li><li class="chapter-item expanded "><a href="../Developer/VSCode-recommended-Extensions.html"><strong aria-hidden="true">1.13.</strong> VSCode recommended Extensions</a></li><li class="chapter-item expanded "><a href="../Developer/Debugging.html"><strong aria-hidden="true">1.14.</strong> Debugging</a></li></ol></li><li class="chapter-item expanded "><a href="../APIUser/APIUser.html"><strong aria-hidden="true">2.</strong> API User Area</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../APIUser/How-to-use-RayCore.html"><strong aria-hidden="true">2.1.</strong> How to use RayCore</a></li><li class="chapter-item expanded "><a href="../APIUser/RAYX-Profiling.html"><strong aria-hidden="true">2.2.</strong> RAY-X Profiling</a></li><li class="chapter-item expanded "><a href="../APIUser/Object-Coordinate-System.html"><strong aria-hidden="true">2.3.</strong> Object Coordinate System</a></li><li class="chapter-item expanded "><a href="../APIUser/User-vs-Model-Parameter.html"><strong aria-hidden="true">2.4.</strong> User vs Model Parameter</a></li><li class="chapter-item expanded "><a href="../APIUser/Ray-generation.html"><strong aria-hidden="true">2.5.</strong> Ray generation</a></li><li class="chapter-item expanded "><a href="../APIUser/VulkanTracer.html"><strong aria-hidden="true">2.6.</strong> Vulkan Tracer</a></li></ol></li><li class="chapter-item expanded "><a href="../AppUser/AppUser.html"><strong aria-hidden="true">3.</strong> App User Area</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../AppUser/How-to-use-the-TerminalApp.html"><strong aria-hidden="true">3.1.</strong> How to use TerminalApp</a></li><li class="chapter-item expanded "><a href="../AppUser/Literature.html"><strong aria-hidden="true">3.2.</strong> Literature</a></li></ol></li><li class="chapter-item expanded "><a href="../Link-Dump.html"><strong aria-hidden="true">4.</strong> Link Dump</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RAY-X Wiki</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="quadric-function"><a class="header" href="#quadric-function">Quad(ric) Function</a></h1>
<p>Function for calculating the intersection of a ray with the surface of an optical element in 3-dimensional space.</p>
<h3 id="input"><a class="header" href="#input">Input:</a></h3>
<ul>
<li>16 parameters $a_{11}$ to $a_{44}$ to define the surface in 3D space with the general equation for second order surfaces. Parameter values for specific surfaces can be found in the <a href="https://it-ed-git.basisit.de/RAY/RAY/-/wikis/uploads/bdcf4515e03b2fccf462c5f0d76052c3/Paper_Schaefers_RAY_Springer_2007.pdf">documentation</a>.</li>
<li>$ray = \begin{bmatrix} x_{S'} \ y_{S'} \z_{S'} \ \end{bmatrix} + t \begin{bmatrix} l_{S'} \ m_{S'}\ n_{S'} \ \end{bmatrix}$</li>
<li>weight/III (set to 0(python)/-4(Fortran) if ray missed surface, unchanged otherwise)</li>
<li>icurv: determines the sign in the formula for calculating $t$, if negative first intersection point, if positive second intersection point.</li>
</ul>
<h3 id="output"><a class="header" href="#output">Output:</a></h3>
<ul>
<li>modified ray</li>
<li>normal at intersection point</li>
<li>weight/III</li>
</ul>
<h3 id="calculation-of-intersection-point"><a class="header" href="#calculation-of-intersection-point">Calculation of intersection point</a></h3>
<p>general equation for second order surfaces:
$$F(x,y,z) = a_{11}x^2 + a_{22}y^2 + a_{33}z^2 + 2a_{12}xy + 2a_{13}xz + 2a_{23}yz + 2a_{14}x + 2a_{24}y + 2a_{34}z + a_{44}$$</p>
<p>The intersection is determined by inserting the x, y and z-coordinates of the ray in $F(x,y,z)$ and set to zero: <br>
$$F(x_{S'}+t \cdot l_{S'} ,y_{S'}+t \cdot m_{S'}, z_{S'}+t \cdot n_{S'}) = 0$$</p>
<p>We obtain a quadratic equation of the form $0 = a \cdot t^2 + b \cdot t + c$ with variable $t$ and the following coefficients:</p>
<p>$$
\begin{align*}
a &amp;= a_{11}l_{S'}^2 + a_{22}m_{S'}^2 + a_{33}n_{S'}^2 + 2a_{13}l_{S'}n_{S'} + 2a_{12}l_{S'}m_{S'} + 2a_{23}m_{S'}n_{S'} \
b &amp;= 2a_{11}x_{S'}l_{S'} + 2a_{22}y_{S'}m_{S'} + 2a_{33}z_{S'}n_{S'} \
&amp;+ 2a_{12}y_{S'}l_{S'} + 2a_{12}x_{S'}m_{S'} 
+ 2a_{13}z_{S'}l_{S'} + 2a_{13}x_{S'}n_{S'} \
&amp;+ 2a_{23}z_{S'}m_{S'} + 2a_{23}y_{S'}n_{S'} 
+ 2a_{14}l_{S'} + 2a_{24}m_{S'} + 2a_{34}n_{S'} \
c &amp;= a_{11}x_{S'}^2 + a_{22}y_{S'}^2 + a_{33}z_{S'}^2 + 2a_{12}x_{S'}y_{S'} + 2a_{13}x_{S'}z_{S'} + 2a_{23}y_{S'}z_{S'} \ 
&amp;+ 2a_{14}x_{S'} + 2a_{24}y_{S'} + 2a_{34}z_{S'} + a_{44}
\end{align*}
$$</p>
<p>Since a, b and c can simply be calculated, we could solve the equation directly with  $t = \frac{-b+ICURV \cdot \sqrt{b^2-4ac}}{2a}$ and use $t$ to find the intersection point. If ICURV is negative, we get the first intersection point with the object (smaller $t$). If ICURV is positive we get the second intersection point from when the ray exits the element (larger $t$). Some optimizations are applied to this formula in the code. Depending on the largest component in the direction of the ray, it is normalized in x, y or z direction to simplify the ray equation. Thus, there are three cases.</p>
<h3 id="optimization"><a class="header" href="#optimization">Optimization</a></h3>
<p>Assume $l_{S'} \geq m_{S'}$ and $l_{S'} \geq n_{S'}$ (first case). Then, we can divide the direction by $l_{S'}$, such that it is normalized in x and the y- and z-coordinates are within $[-1,1]$ (I). Moreover, we can translate the origin of the ray along the direction vector towards the origin of the coordinate system until the $y$-$z$-plane is hit $(x=0, II)$. Then, we end up with a normalized ray (III), where $x=t$.</p>
<p>$$
\begin{align*}
ray 
&amp;\overset{\text{I}}{=} \begin{bmatrix} x_{S'} \ y_{S'} \z_{S'} \ \end{bmatrix} + t \begin{bmatrix} 1 \ m_{S'}/l_{S'}\ n_{S'}/l_{S'} \ \end{bmatrix} \
&amp;\overset{\text{II}}{=} \begin{bmatrix} x_{S'}-1\cdot x_{S'} \ y_{S'} - (m_{S'}/l_{S'}) \cdot y_{S'} \z_{S'} - (n_{S'}/l_{S'}) \cdot z_{S'} \ \end{bmatrix} + t \begin{bmatrix} 1 \ m_{S'}/l_{S'}\ n_{S'}/l_{S'} \ \end{bmatrix} \
&amp;\overset{\text{III}}{=} \begin{bmatrix} 0 \ y \ z \end{bmatrix} + t \begin{bmatrix} 1 \ a_{ml} \ a_{nl} \ \end{bmatrix} 
\end{align*}
$$</p>
<p>When we plug this parameterization of the ray into $F(x,y,z)=0$, some terms in a, b and c are removed (see code).</p>
<p>Since every term in b contains the factor 2, the equation for calculating t can be simplified:
$$
t = \frac{-2\frac{b}{2} +ICURV \cdot \sqrt{(2\frac{b}{2})^2 - 4ac}}{2a} = \frac{-2\frac{b}{2} +ICURV \cdot 2\sqrt{(\frac{b}{2})^2 - ac}}{2a} = \frac{-\frac{b}{2} +ICURV \cdot \sqrt{(\frac{b}{2})^2 - ac}}{a}
$$</p>
<p>In the code the factor 2 is left out of the equation for $b$ from the beginning. Thus, what is called $b$ in the code is actually $\frac{b}{2}$.</p>
<p>If the term in the root is negative there is no intersection and weight is set to 0 (or III to -4 in fortran). 
Otherwise it is checked whether the factor a is much smaller than $c$. Then, the divisor is very small or zero which can cause problems with the division. In that case, $a \cdot t^2$ is removed from the quadratic equation $a \cdot t^2 + b \cdot t + c$ which thus yields $t=x=- \frac{c}{b}$ or $t=x= \frac{c}{2b}$ in the code since the factor $2$ is excluded from $b$ (<a href="https://www.cs.uaf.edu/2012/spring/cs481/section/0/lecture/01_26_ray_intersections.html">see also</a> (Ray Quadric Intersection)). 
If $a$ is not much smaller than $c$, $t$ is calculated with the simplified equation above. Subsequently, $t (=x)$ is plugged into the modified ray equation and the intersection point is calculated.</p>
<p>The other two cases for when $y$ or $z$ are the largest component of the direction of the ray are similar.</p>
<p>The partial derivatives of $F(x,y,z)$ form the normal vector $f_{x,y,z}$ of the surface. Inserting the calculated intersection point into the normal vector yields the normal of the surface at this specific point. The intersection point is set to be the new origin of the ray. The ray direction $(l_{S'},m_{S'},n_{S'})$ remains unchanged.</p>
<h3 id="general-equation-for-second-order-surfaces"><a class="header" href="#general-equation-for-second-order-surfaces">General equation for second order surfaces</a></h3>
<p>The equation can describe the surface of several elements in a similar way as a circle with radius 1 can be described in 2D as $x^2 + y^2 -1 = 0$. Elements that can be described by this general equation include sphere, ellipsoid, plane, cone, cylinder, paraboloid. These are so called quadric surfaces. Surfaces that cannot be described by any quadratic function include for example the torus.
The equation refers to a right-handed coordinate system with the center of the optical element in the origin. The element's surface is the x-z-plane and the y-axis is the normal vector. </p>
<p>$$
\begin{align*}
F(x,y,z) &amp;= \vec{x}^TA\vec{x} \
\vec{x} = \begin{bmatrix} x \ y \ z \ 1 \end{bmatrix}
A &amp;= \begin{bmatrix} a_{11} &amp; a_{12} &amp; a_{13} &amp; a_{14} \
a_{21} &amp; a_{22} &amp; a_{23} &amp; a_{24} \
a_{31} &amp; a_{32} &amp; a_{33} &amp; a_{34} \
a_{41} &amp; a_{42} &amp; a_{43} &amp; a_{44} 
\end{bmatrix} \
a_{ij} = a_{ji} &amp;\Rightarrow A^T = A
\end{align*}
$$</p>
<p>Literature: <br>
<a href="https://en.wikipedia.org/wiki/Quadric">https://en.wikipedia.org/wiki/Quadric</a> <br>
<a href="https://www.win.tue.nl/%7Esterk/Bouwkunde/2db60-chap3.pdf">https://www.win.tue.nl/~sterk/Bouwkunde/2db60-chap3.pdf</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Developer/Transformation-between-coordinate-systems.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../Developer/Approximation-of-ray-object-intersection-in-the-case-of-quadric-surfaces.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Developer/Transformation-between-coordinate-systems.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../Developer/Approximation-of-ray-object-intersection-in-the-case-of-quadric-surfaces.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
